---
Resources:
  LambdaBasicExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  CreditBureau:
    Type: AWS::Lambda::Function
    Properties:
      Role: !GetAtt LambdaBasicExecutionRole.Arn
      PackageType: Image
      Code:
        ImageUri: !Sub ${AWS::AccountId}.dkr.ecr.sa-east-1.amazonaws.com/creditbureau:latest
      FunctionName: loan-broker-CreditBureau

  BankRecipientPawnshop:
    Type: AWS::Lambda::Function
    Properties:
      Role: !GetAtt LambdaBasicExecutionRole.Arn
      PackageType: Image
      Code:
        ImageUri: !Sub ${AWS::AccountId}.dkr.ecr.sa-east-1.amazonaws.com/bankrecipient:latest
      FunctionName: loan-broker-BankRecipientPawnshop
      Environment:
        Variables:
          BANK_ID: PawnShop
          BASE_RATE: 5
          MAX_LOAN_AMOUNT: 500000
          MIN_CREDIT_SCORE: 400

  BankRecipientUniversal:
    Type: AWS::Lambda::Function
    Properties:
      Role: !GetAtt LambdaBasicExecutionRole.Arn
      PackageType: Image
      Code:
        ImageUri: !Sub ${AWS::AccountId}.dkr.ecr.sa-east-1.amazonaws.com/bankrecipient:latest
      FunctionName: loan-broker-BankRecipientUniversal
      Environment:
        Variables:
          BANK_ID: Universal
          BASE_RATE: 4
          MAX_LOAN_AMOUNT: 700000
          MIN_CREDIT_SCORE: 500

  BankRecipientPremium:
    Type: AWS::Lambda::Function
    Properties:
      Role: !GetAtt LambdaBasicExecutionRole.Arn
      PackageType: Image
      Code:
        ImageUri: !Sub ${AWS::AccountId}.dkr.ecr.sa-east-1.amazonaws.com/bankrecipient:latest
      FunctionName: loan-broker-BankRecipientPremium
      Environment:
        Variables:
          BANK_ID: Premium
          BASE_RATE: 3
          MAX_LOAN_AMOUNT: 900000
          MIN_CREDIT_SCORE: 600

  MortgageQuoteRequest:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: MortgageQuoteRequest

  BankRecipientPawnshopSNSSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt BankRecipientPawnshop.Arn
      Protocol: lambda
      TopicArn: !GetAtt MortgageQuoteRequest.Arn

  BankRecipientUniversalSNSSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt BankRecipientUniversal.Arn
      Protocol: lambda
      TopicArn: !GetAtt MortgageQuoteRequest.Arn

  BankRecipientPremiumSNSSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt BankRecipientPremium.Arn
      Protocol: lambda
      TopicArn: !GetAtt MortgageQuoteRequest.Arn

